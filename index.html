<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>تقرير حصص الانتظار – الثانوية السادسة والعشرون (تبوك)</title>

  <!-- خط عربي واضح -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      /* هوية خضراء */
      --primary:#28a745;
      --secondary:#20c997;
      --accent:#28a745;
      --accent-2:#1e7e34;

      --ink:#263b33;            /* لون النص */
      --ink-soft:#4b6a5d;
      --border:#e3ece6;
      --border-2:#d8e5dc;
      --paper:#ffffff;
      --page:#f6faf8;

      --banner-bg:#e8f6ef;
      --banner-ink:#116e4f;

      --shadow:0 4px 16px rgba(0,0,0,.06);
      --shadow-soft:0 2px 10px rgba(0,0,0,.04);
    }

    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--page);color:var(--ink);font-family:"Tajawal", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;line-height:1.7}
    a{color:inherit;text-decoration:none}

    .container{max-width:1180px;margin:18px auto;padding:0 14px}

    /* ديباجة العرض */
    .banner{background:var(--banner-bg);color:var(--banner-ink);border:1px solid var(--border);border-radius:18px;padding:16px 18px;display:flex;align-items:center;justify-content:space-between;gap:12px;box-shadow:var(--shadow-soft)}
    .title{font-weight:800;font-size:1.4rem;text-align:center;flex:1}

    .btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer;display:inline-flex;align-items:center;gap:8px}
    .btn-primary{background:var(--accent);color:#fff;box-shadow:0 6px 18px rgba(40,167,69,.18)}
    .btn-primary:hover{background:var(--accent-2)}
    .btn-ghost{background:#fff;border:1px solid var(--border);color:#204c3d}
    .btn-danger{background:#fee2e2;color:#b91c1c;border:1px solid #fecaca}
    .btn-danger:hover{background:#fecaca}

    .stack{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

    .card{background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);overflow:hidden}
    .card-h{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:12px;background:linear-gradient(180deg,#fbfdfc,#fff)}
    .card-b{padding:16px}

    .teacher{display:flex;align-items:center;gap:10px}
    .teacher label{color:var(--ink-soft);font-weight:700;white-space:nowrap}
    .teacher input{min-width:220px;border:1px solid var(--border-2);border-radius:10px;padding:9px 12px;text-align:center;outline:0}
    .teacher input:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(40,167,69,.08)}

    /* جدول نصي فقط (لا حقول داخل الجدول) */
    .table-wrap{border:1px solid var(--border);border-radius:14px;overflow:hidden;box-shadow:var(--shadow-soft)}
    table{border-collapse:separate;border-spacing:0;width:100%;background:var(--paper)}
    thead th{position:sticky;top:0;background:#f1fbf6;color:#1d6a4f;z-index:5;font-weight:800;border-bottom:1px solid var(--border);text-align:center}
    th,td{border-right:1px solid var(--border);border-bottom:1px solid var(--border);padding:12px 10px;text-align:center;vertical-align:middle}
    th:first-child,td:first-child{border-right:none}
    tbody tr:nth-child(even) td{background:#fbfdfc}
    tbody tr:hover td{background:#f4faf6}
    .tags{display:flex;gap:6px;justify-content:center;flex-wrap:wrap}
    .tag{border:1px solid var(--border-2);background:#f7faf8;padding:4px 8px;border-radius:999px;font-size:.86rem;color:#2a5d4c}

    .week-title{font-weight:800;color:#2b6f57}

    /* نافذة إضافة/تعديل الصف (خارج الجدول) */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
    .modal.show{display:flex}
    .modal-card{background:#fff;border-radius:16px;box-shadow:var(--shadow);max-width:760px;width:100%;overflow:hidden}
    .modal-h{padding:14px 16px;border-bottom:1px solid var(--border);font-weight:800;color:#2b6f57}
    .modal-b{padding:16px}
    .grid{display:grid;grid-template-columns:repeat(2, minmax(0,1fr));gap:12px}
    .field{display:flex;flex-direction:column;gap:6px}
    .field label{font-weight:700;color:var(--ink-soft)}
    .field input,.field select,.field textarea{border:1px solid var(--border-2);border-radius:10px;padding:9px 12px;text-align:center;outline:0}
    .field textarea{min-height:70px;text-align:right}
    .checks{display:flex;gap:8px;flex-wrap:wrap}
    .checks label{display:flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:10px;padding:8px 10px;background:#f7faf8}
    .modal-f{padding:14px 16px;border-top:1px solid var(--border);display:flex;justify-content:flex-start;gap:10px}

    /* print helpers */
    .no-print{display:initial}
    .print-only{display:none}
    /* أثناء التصدير نُظهر عناصر print-only ونخفي no-print */
    .printing .print-only{display:flex !important}
    .printing .no-print{display:none !important}

    /* طباعة: الديباجة + جميع الجداول فقط */
    @media print{
      .no-print{display:none!important}
      .print-only{display:flex!important}
      body{background:#fff!important}
      .container{max-width:none;margin:0;padding:0}
      .banner, .card{border-radius:0;box-shadow:none}
      thead th{background:#eaeaea!important;color:#000!important;-webkit-print-color-adjust:exact;print-color-adjust:exact}
      th,td{border:1px solid #000!important}
      table{border:2px solid #000}
    }

    /* تذليل الموقع */
    .footer{
      margin-top:16px;
      background:var(--banner-bg);
      color:var(--banner-ink);
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px 16px;
      text-align:center;       /* الأسماء بالمنتصف */
      box-shadow:var(--shadow-soft);
    }
  </style>

  <!-- PDF libs -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body>
  <div class="container">

    <!-- ديباجة العرض (مرئيّة على الشاشة فقط) -->
    <div class="banner no-print">
      <div class="title">الثانوية السادسة والعشرون - تبوك</div>
      <div class="stack">
        <button id="addWeekBtn" class="btn btn-primary">إضافة أسبوع</button>
        <button id="exportBtn" class="btn btn-primary">تصدير PDF</button>
      </div>
    </div>

    <!-- منطقة التصدير/الطباعة: تضم ديباجة للطباعة فقط + كل الأسابيع -->
    <div id="exportArea" style="margin-top:14px">
      <!-- هذه الديباجة للطباعة/التصدير فقط، ومخفية في العرض -->
      <div class="banner print-only" style="box-shadow:none">
        <div class="title">الثانوية السادسة والعشرون - تبوك</div>
        <div style="width:120px"></div>
      </div>

      <div id="weeks"></div>
    </div>

    <!-- تذليل (أخضر وبالمنتصف – عرض فقط) -->
    <div class="footer no-print">
      <div>مديرة المدرسة: <strong>أماني آل عبشان</strong></div>
      <div>تصميم الهيئة الإدارية: <strong>عيدة صلاح</strong>، <strong>منيرة العمراني</strong></div>
    </div>
  </div>

  <!-- نافذة إضافة/تعديل صف -->
  <div id="rowModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="rowModalTitle">
    <div class="modal-card">
      <div class="modal-h" id="rowModalTitle">إدخال بيانات الصف</div>
      <div class="modal-b">
        <div class="grid">
          <div class="field">
            <label>اليوم</label>
            <select id="f_day">
              <option value=""></option>
              <option>الأحد</option><option>الاثنين</option><option>الثلاثاء</option><option>الأربعاء</option><option>الخميس</option>
            </select>
          </div>
          <div class="field">
            <label>التاريخ</label>
            <input id="f_date" type="date">
          </div>
          <div class="field">
            <label>الصف</label>
            <input id="f_grade">
          </div>
          <div class="field">
            <label>الحصة</label>
            <input id="f_period">
          </div>
          <div class="field">
            <label>المعلمة الغائبة</label>
            <input id="f_absent">
          </div>
          <div class="field" style="grid-column:1/-1">
            <label>ما تم تنفيذه</label>
            <textarea id="f_exec"></textarea>
          </div>
          <div class="field" style="grid-column:1/-1">
            <label>الشاهد</label>
            <textarea id="f_witness"></textarea>
          </div>
          <div class="field" style="grid-column:1/-1">
            <label>المجال</label>
            <div class="checks">
              <label><input type="checkbox" id="c_basics"> المهارات الأساسية</label>
              <label><input type="checkbox" id="c_values"> القيم والمواطنة الصالحة</label>
              <label><input type="checkbox" id="c_future"> مهارات المستقبل</label>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-f">
        <button id="saveRowBtn" class="btn btn-primary">حفظ</button>
        <button id="cancelRowBtn" class="btn btn-ghost">إلغاء</button>
      </div>
    </div>
  </div>

  <script>
  (function(){
    const DAYS = ["","الأحد","الاثنين","الثلاثاء","الأربعاء","الخميس"];
    const LS_KEY = "sr-v7-weeks";

    const weeksEl = document.getElementById("weeks");
    const addWeekBtn = document.getElementById("addWeekBtn");
    const exportBtn = document.getElementById("exportBtn");

    // modal refs
    const rowModal = document.getElementById("rowModal");
    const f_day = document.getElementById("f_day");
    const f_date = document.getElementById("f_date");
    const f_grade = document.getElementById("f_grade");
    const f_period = document.getElementById("f_period");
    const f_absent = document.getElementById("f_absent");
    const f_exec = document.getElementById("f_exec");
    const f_witness = document.getElementById("f_witness");
    const c_basics = document.getElementById("c_basics");
    const c_values = document.getElementById("c_values");
    const c_future = document.getElementById("c_future");
    const saveRowBtn = document.getElementById("saveRowBtn");
    const cancelRowBtn = document.getElementById("cancelRowBtn");

    let state = load();
    let editCtx = null; // {weekId, idx} أو {weekId, idx:null} للإضافة

    function load(){
      try{
        const s = localStorage.getItem(LS_KEY);
        if (s) return JSON.parse(s);
      }catch(e){}
      return { weeks: [ newWeek() ] };
    }
    function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

    function newWeek(){
      const id = "w-" + Date.now() + "-" + Math.random().toString(16).slice(2);
      return {
        id, teacherName:"", title:"الأسبوع",
        rows: DAYS.slice(1).map(d => ({day:d,date:"",grade:"",period:"",absent:"",executed:"",witness:"",domain:{b:false,v:false,f:false}}))
      };
    }

    function render(){
      weeksEl.innerHTML = "";
      state.weeks.forEach((wk, wIdx) => {
        weeksEl.appendChild(renderWeekCard(wk, wIdx));
      });
      save();
    }

    function renderWeekCard(wk, wIdx){
      const wrap = document.createElement("section");
      wrap.className = "card";
      wrap.style.marginTop = "16px";

      // header
      const h = document.createElement("div");
      h.className = "card-h";
      const left = document.createElement("div");
      left.className = "stack";
      const title = document.createElement("div");
      title.className = "week-title";
      title.textContent = wk.title + " #" + (wIdx+1);
      left.appendChild(title);

      const teacherBox = document.createElement("div");
      teacherBox.className = "teacher";
      const label = document.createElement("label");
      label.textContent = "اسم المعلمة:";
      const input = document.createElement("input");
      input.value = wk.teacherName || "";
      input.addEventListener("input", () => { wk.teacherName = input.value; save(); });
      teacherBox.appendChild(label); teacherBox.appendChild(input);
      left.appendChild(teacherBox);

      const right = document.createElement("div");
      right.className = "stack";
      const addRowBtn = document.createElement("button");
      addRowBtn.className = "btn btn-primary";
      addRowBtn.textContent = "+ صف";
      addRowBtn.addEventListener("click", () => openRowModal(wk.id, null));
      right.appendChild(addRowBtn);

      if (state.weeks.length > 1){
        const delWeek = document.createElement("button");
        delWeek.className = "btn btn-danger";
        delWeek.textContent = "حذف الأسبوع";
        delWeek.addEventListener("click", () => {
          state.weeks = state.weeks.filter(x => x.id !== wk.id);
          render();
        });
        right.appendChild(delWeek);
      }

      h.appendChild(left); h.appendChild(right);
      wrap.appendChild(h);

      // body with table (TEXT ONLY)
      const b = document.createElement("div");
      b.className = "card-b";
      const tableWrap = document.createElement("div");
      tableWrap.className = "table-wrap";
      const table = document.createElement("table");

      table.innerHTML = `
        <thead>
          <tr>
            <th>#</th>
            <th>اليوم</th>
            <th>التاريخ</th>
            <th>الصف</th>
            <th>الحصة</th>
            <th>المعلمة الغائبة</th>
            <th>ما تم تنفيذه</th>
            <th>الشاهد</th>
            <th>المجال</th>
            <th class="no-print">إجراءات</th>
          </tr>
        </thead>
        <tbody></tbody>
      `;
      const tbody = table.querySelector("tbody");

      // ensure rows exist
      if (!wk.rows || !wk.rows.length){
        wk.rows = DAYS.slice(1).map(d => ({day:d,date:"",grade:"",period:"",absent:"",executed:"",witness:"",domain:{b:false,v:false,f:false}}));
      }

      wk.rows.forEach((r, i) => {
        const tr = document.createElement("tr");
        tr.appendChild(tdText(i+1));
        tr.appendChild(tdText(r.day || ""));
        tr.appendChild(tdText(r.date || ""));
        tr.appendChild(tdText(r.grade || ""));
        tr.appendChild(tdText(r.period || ""));
        tr.appendChild(tdText(r.absent || ""));
        tr.appendChild(tdText(r.executed || ""));
        tr.appendChild(tdText(r.witness || ""));

        const domTd = document.createElement("td");
        const tags = [];
        if (r.domain?.b) tags.push("المهارات الأساسية");
        if (r.domain?.v) tags.push("القيم والمواطنة الصالحة");
        if (r.domain?.f) tags.push("مهارات المستقبل");
        domTd.appendChild(renderTags(tags));
        tr.appendChild(domTd);

        const act = document.createElement("td");
        act.className = "no-print";
        const edit = document.createElement("button");
        edit.className = "btn btn-ghost"; edit.textContent = "تعديل";
        edit.addEventListener("click", () => openRowModal(wk.id, i));
        const del = document.createElement("button");
        del.className = "btn btn-danger"; del.textContent = "حذف";
        del.addEventListener("click", () => { wk.rows.splice(i,1); render(); });
        const stack = document.createElement("div"); stack.className = "stack";
        stack.appendChild(edit); stack.appendChild(del);
        act.appendChild(stack);
        tr.appendChild(act);

        tbody.appendChild(tr);
      });

      tableWrap.appendChild(table);
      b.appendChild(tableWrap);
      wrap.appendChild(b);
      return wrap;
    }

    function tdText(t){ const td=document.createElement("td"); td.textContent=t; return td; }
    function renderTags(arr){
      const wrap = document.createElement("div"); wrap.className = "tags";
      if (!arr.length){ wrap.textContent = "—"; return wrap; }
      arr.forEach(x => { const s=document.createElement("span"); s.className="tag"; s.textContent=x; wrap.appendChild(s); });
      return wrap;
    }

    // Modal helpers
    let editCtx = null;
    function openRowModal(weekId, idx){
      editCtx = { weekId, idx };
      const wk = state.weeks.find(w => w.id === weekId);
      const r = idx==null ? {day:"",date:"",grade:"",period:"",absent:"",executed:"",witness:"",domain:{b:false,v:false,f:false}} : wk.rows[idx];

      f_day.value = r.day || "";
      f_date.value = r.date || "";
      f_grade.value = r.grade || "";
      f_period.value = r.period || "";
      f_absent.value = r.absent || "";
      f_exec.value = r.executed || "";
      f_witness.value = r.witness || "";
      c_basics.checked = !!r.domain?.b;
      c_values.checked = !!r.domain?.v;
      c_future.checked = !!r.domain?.f;

      rowModal.classList.add("show");
    }
    function closeRowModal(){ rowModal.classList.remove("show"); editCtx = null; }

    document.getElementById("saveRowBtn").addEventListener("click", () => {
      if (!editCtx) return;
      const wk = state.weeks.find(w => w.id === editCtx.weekId);
      const obj = {
        day: f_day.value, date: f_date.value, grade: f_grade.value, period: f_period.value,
        absent: f_absent.value, executed: f_exec.value, witness: f_witness.value,
        domain: { b: c_basics.checked, v: c_values.checked, f: c_future.checked }
      };
      if (editCtx.idx == null) wk.rows.push(obj); else wk.rows[editCtx.idx] = obj;
      save(); render(); closeRowModal();
    });
    document.getElementById("cancelRowBtn").addEventListener("click", closeRowModal);
    rowModal.addEventListener("click", (e)=>{ if (e.target === rowModal) closeRowModal(); });

    // إضافة أسبوع
    addWeekBtn.addEventListener("click", () => { state.weeks.push(newWeek()); render(); });

    // تصدير PDF: نظهر عناصر print-only ونخفي no-print أثناء الالتقاط
    exportBtn.addEventListener("click", async () => {
      const area = document.getElementById("exportArea");
      area.classList.add("printing");          // يفعل قواعد الإخفاء/الإظهار للتصدير
      await new Promise(r => setTimeout(r, 50)); // لقطة مستقرة
      const canvas = await html2canvas(area, { scale: 2, useCORS: true });
      area.classList.remove("printing");
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF("p","mm","a4");
      const img = canvas.toDataURL("image/jpeg", 0.95);
      const pageW=210, pageH=297;
      const imgW=pageW, imgH=(canvas.height*imgW)/canvas.width;
      let heightLeft=imgH, pos=0;
      pdf.addImage(img,"JPEG",0,pos,imgW,imgH,undefined,"FAST");
      heightLeft -= pageH;
      while(heightLeft>0){ pos = heightLeft - imgH; pdf.addPage(); pdf.addImage(img,"JPEG",0,pos,imgW,imgH,undefined,"FAST"); heightLeft -= pageH; }
      pdf.save("تقرير-حصص-الانتظار.pdf");
    });

    render();
  })();
  </script>
</body>
</html>

