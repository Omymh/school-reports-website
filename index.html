<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ØªÙ‚Ø±ÙŠØ± Ø­ØµØµ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± â€“ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„Ø³Ø§Ø¯Ø³Ø© ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ† (ØªØ¨ÙˆÙƒ)</title>

  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet" />

  <style>
    :root{
      --primary:#28a745; --primary-dark:#1e7e34;
      --ink:#263b33; --ink-soft:#4b6a5d;
      --border:#e3ece6; --border-2:#d8e5dc;
      --page:#f6faf8; --paper:#fff;
      --r:16px;
      --shadow:0 6px 22px rgba(0,0,0,.06);
      --shadow-soft:0 2px 10px rgba(0,0,0,.04);
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--page);color:var(--ink);
      font-family:"Tajawal",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;line-height:1.75;overflow-x:hidden}

    .container{max-width:1180px;margin:20px auto;padding:0 16px;overflow:hidden}

    /* Ø§Ù„Ø¯ÙŠØ¨Ø§Ø¬Ø© */
    .site-banner{background:#fff;border:1px solid var(--border-2);border-radius:var(--r);padding:12px;box-shadow:var(--shadow-soft);overflow:hidden}
    .site-banner .img-wrap{border:1px solid var(--border-2);border-radius:12px;padding:8px;background:#fff;overflow:hidden}
    .site-banner img{display:block;max-width:100%;height:auto;border-radius:10px;margin:0 auto}

    /* Ø§Ù„Ø£Ø¯ÙˆØ§Øª */
    .toolbar{margin:14px 0;background:#fff;border:1px solid var(--border-2);border-radius:var(--r);
      padding:12px;display:flex;gap:10px;align-items:center;justify-content:space-between;box-shadow:var(--shadow-soft);overflow:hidden}
    .title{font-weight:800}
    .btn{appearance:none;border:0;border-radius:12px;padding:10px 16px;font-weight:800;cursor:pointer;display:inline-flex;align-items:center;gap:8px}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-primary:hover{background:var(--primary-dark)}
    .btn-ghost{background:#fff;border:1px solid var(--border-2);color:#204c3d}
    .btn-danger{background:#fee2e2;color:#b91c1c;border:1px solid #fecaca}
    .btn-xs{padding:6px 10px;border-radius:10px;font-size:.92rem}
    .stack{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

    /* Ø¨Ø·Ø§Ù‚Ø§Øª */
    .card{background:#fff;border:1px solid var(--border-2);border-radius:var(--r);box-shadow:var(--shadow);overflow:hidden}
    .card + .card{margin-top:16px}
    .card-h{padding:12px 14px;border-bottom:1px solid var(--border-2);
      display:flex;align-items:center;justify-content:space-between;gap:12px;background:linear-gradient(180deg,#fbfdfc,#fff)}
    .card-b{padding:14px}
    .teacher{display:flex;align-items:center;gap:10px}
    .teacher label{font-weight:700;color:var(--ink-soft)}
    .teacher input{min-width:260px;border:1px solid var(--border-2);border-radius:10px;padding:10px 14px;text-align:center;outline:0}
    .teacher input:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(40,167,69,.10)}

    /* Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
    .table-wrap{border:1px solid var(--border-2);border-top:0;border-radius:0 0 var(--r) var(--r);overflow:auto;position:relative}
    .table-wrap::after{content:"â†” Ø§Ø³Ø­Ø¨ Ø£ÙÙ‚ÙŠØ§Ù‹"; position:absolute; top:8px; left:12px; font-size:.85rem; color:#9ab2a6}
    table{border-collapse:separate;border-spacing:0;width:100%;background:var(--paper);table-layout:auto}
    thead th{position:sticky;top:0;z-index:2;background:#f3f7f5;color:#1f4738;font-weight:800;border-bottom:1px solid var(--border-2);text-align:center;white-space:nowrap}
    th,td{border-right:1px solid var(--border-2);border-bottom:1px solid var(--border-2);padding:10px 8px;text-align:center;vertical-align:middle;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    th:first-child,td:first-child{border-right:none}
    tbody tr:nth-child(even) td{background:#fbfdfc}
    tbody tr:hover td{background:#f4faf6}

    th.col-idx{width:48px} th.col-day{width:110px} th.col-date{width:150px}
    th.col-grade{width:120px} th.col-period{width:120px} th.col-absent{width:180px}
    th.col-domain{width:210px} th.col-actions{width:170px}

    /* Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© (ØªØ¸Ù‡Ø± ÙÙŠ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙÙ‚Ø·) */
    .print-meta{display:none;margin:10px 0 6px;padding:8px 10px;border:1px dashed var(--border-2);border-radius:10px;text-align:center;color:#1f4738}
    .print-meta b{color:#1f4738}

    /* Ø§Ù„Ø´ÙˆØ§Ù‡Ø¯ (Ø£Ø³ÙÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„) */
    .witness{padding:12px 0 4px}
    .witness h4{margin:0 0 8px;font-weight:800}
    .w-grid{display:flex;gap:10px;flex-wrap:wrap}
    .w-grid .slot{width:100px;height:100px;border:1px solid var(--border-2);border-radius:10px;overflow:hidden;background:#f7faf8;display:flex;align-items:center;justify-content:center}
    .w-grid .slot.empty{background:#f7faf8}
    .w-grid img{width:100%;height:100%;object-fit:cover;display:block}
    .w-actions{display:flex;gap:8px;align-items:center;margin-top:8px}

    /* ØªØ°ÙŠÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ */
    .footer{margin-top:14px;background:#e9f6ef;border:1px solid var(--border-2);border-radius:var(--r);padding:10px 12px;text-align:center;overflow:hidden}
    .footer small{display:block;color:#215843}

    /* Ø·Ø¨Ø§Ø¹Ø©/ØªØµØ¯ÙŠØ± */
    .no-print{display:initial} .print-only{display:none}
    .exporting .no-print{display:none!important} .exporting .print-only{display:block!important}
    .exporting th.col-actions, .exporting td.col-actions { display:none!important; }
    .exporting .print-meta{display:block!important;}
    @media print{ th.col-actions, td.col-actions { display:none!important; } .print-meta{display:block!important;} }

    @media print{
      @page{size:A4 landscape; margin:10mm}
      body{background:#fff!important}
      .card{page-break-after:always}
      thead th{background:#eaeaea!important;color:#000!important;-webkit-print-color-adjust:exact;print-color-adjust:exact}
      th,td{border:1px solid #000!important;white-space:normal}
      .table-wrap::after{content:none}
    }

    /* Ø§Ù„Ø¬ÙˆØ§Ù„ */
    @media (max-width:640px){
      .container{padding:0 12px}
      .toolbar{flex-direction:column;gap:10px;align-items:stretch}
      .table-wrap{border-radius:0 0 12px 12px;overflow-x:auto;-webkit-overflow-scrolling:touch}
      table{min-width:980px}
      thead th{font-size:.92rem}
      th,td{padding:9px 8px;font-size:.92rem}
      td.col-actions .btn{padding:6px 10px}
    }

    /* ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ØªØµØ¯ÙŠØ± */
    #printSandbox{position:fixed;left:-99999px;top:0;width:1200px;background:#fff;pointer-events:none;opacity:0}
    #printSandbox .sheet{margin:0 0 18px 0;border:1px solid #eee;border-radius:12px;overflow:hidden}
  </style>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body>
  <div class="container">
    <!-- Ø§Ù„Ø¯ÙŠØ¨Ø§Ø¬Ø© Ø¨Ø§Ù„Ù…ÙˆÙ‚Ø¹ -->
    <div class="site-banner">
      <div class="img-wrap"><img id="siteBannerImg" src="26.png" alt="Ø¯ÙŠØ¨Ø§Ø¬Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±" /></div>
    </div>

    <!-- Ø§Ù„Ø£Ø¯ÙˆØ§Øª -->
    <div class="toolbar no-print">
      <div class="title">ØªÙ‚Ø±ÙŠØ± Ø­ØµØµ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</div>
      <div class="stack">
        <button id="addWeekBtn" class="btn btn-primary">Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ø¨ÙˆØ¹</button>
        <button id="exportBtn" class="btn btn-primary">ØªØµØ¯ÙŠØ± PDF</button>
      </div>
    </div>

    <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± -->
    <div id="exportArea">
      <!-- Ø§Ù„Ø¯ÙŠØ¨Ø§Ø¬Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙÙ‚Ø· -->
      <div class="print-only" id="printBanner">
        <img id="printBannerImg" src="26.png" alt="Ø¯ÙŠØ¨Ø§Ø¬Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±" style="max-width:100%;display:block;margin:0 auto" />
      </div>
      <div id="weeks"></div>
    </div>

    <!-- ØªØ°ÙŠÙŠÙ„ (Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙ‚Ø·) -->
    <div class="footer no-print">
      <small>Ù…Ø¯ÙŠØ±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³Ø©: <strong>Ø£Ù…Ø§Ù†ÙŠ Ø¢Ù„ Ø¹Ø¨Ø´Ø§Ù†</strong></small>
      <small>ØªØµÙ…ÙŠÙ… Ø§Ù„Ù‡ÙŠØ¦Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©: <strong>Ø¹ÙŠØ¯Ø© ØµÙ„Ø§Ø­</strong>ØŒ <strong>Ù…Ù†ÙŠØ±Ø© Ø§Ù„Ø¹Ù…Ø±Ø§Ù†ÙŠ</strong></small>
    </div>
  </div>

  <!-- Ù†Ø§ÙØ°Ø© ØµÙ -->
  <div id="rowModal" class="modal no-print" style="position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:16px;z-index:50">
    <div class="modal-card" style="background:#fff;border-radius:16px;box-shadow:var(--shadow);max-width:760px;width:100%;overflow:hidden;border:1px solid var(--border-2)">
      <div class="modal-h" style="padding:12px 14px;border-bottom:1px solid var(--border-2);font-weight:800">Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙ</div>
      <div class="modal-b" style="padding:14px">
        <div style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px">
          <div><label>Ø§Ù„ÙŠÙˆÙ…</label>
            <select id="f_day" style="width:100%;border:1px solid var(--border-2);border-radius:10px;padding:10px 12px;text-align:center">
              <option value=""></option><option>Ø§Ù„Ø£Ø­Ø¯</option><option>Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</option><option>Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option><option>Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option><option>Ø§Ù„Ø®Ù…ÙŠØ³</option>
            </select>
          </div>
          <div><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input id="f_date" type="date" style="width:100%;border:1px solid var(--border-2);border-radius:10px;padding:10px 12px;text-align:center"></div>
          <div><label>Ø§Ù„ØµÙ</label><input id="f_grade" style="width:100%;border:1px solid var(--border-2);border-radius:10px;padding:10px 12px;text-align:center"></div>
          <div><label>Ø§Ù„Ø­ØµØ©</label><input id="f_period" style="width:100%;border:1px solid var(--border-2);border-radius:10px;padding:10px 12px;text-align:center"></div>
          <div><label>Ø§Ù„Ù…Ø¹Ù„Ù…Ø© Ø§Ù„ØºØ§Ø¦Ø¨Ø©</label><input id="f_absent" style="width:100%;border:1px solid var(--border-2);border-radius:10px;padding:10px 12px;text-align:center"></div>
          <div style="grid-column:1/-1"><label>Ù…Ø§ ØªÙ… ØªÙ†ÙÙŠØ°Ù‡</label><textarea id="f_exec" style="width:100%;border:1px solid var(--border-2);border-radius:10px;padding:10px 12px;min-height:70px"></textarea></div>
          <div style="grid-column:1/-1">
            <label>Ø§Ù„Ù…Ø¬Ø§Ù„</label>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <label style="display:flex;gap:6px;align-items:center;border:1px solid var(--border-2);border-radius:10px;padding:6px 10px;background:#f7faf8"><input type="checkbox" id="c_basics"> Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</label>
              <label style="display:flex;gap:6px;align-items:center;border:1px solid var(--border-2);border-radius:10px;padding:6px 10px;background:#f7faf8"><input type="checkbox" id="c_values"> Ø§Ù„Ù‚ÙŠÙ… ÙˆØ§Ù„Ù…ÙˆØ§Ø·Ù†Ø© Ø§Ù„ØµØ§Ù„Ø­Ø©</label>
              <label style="display:flex;gap:6px;align-items:center;border:1px solid var(--border-2);border-radius:10px;padding:6px 10px;background:#f7faf8"><input type="checkbox" id="c_future"> Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„</label>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-f" style="display:flex;gap:10px;justify-content:flex-start;padding:12px 14px">
        <button id="saveRowBtn" class="btn btn-primary">Ø­ÙØ¸</button>
        <button id="cancelRowBtn" class="btn btn-ghost">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div>

  <script>
  (function(){
    function attachFallback(img){
      img.addEventListener('error', function(){
        if(this.src.endsWith('26.png')) this.src='26.jpg';
        else if(this.src.endsWith('26.jpg')) this.src='26.jpeg';
      });
    }
    attachFallback(document.getElementById('siteBannerImg'));
    attachFallback(document.getElementById('printBannerImg'));

    const DAYS=["","Ø§Ù„Ø£Ø­Ø¯","Ø§Ù„Ø§Ø«Ù†ÙŠÙ†","Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡","Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡","Ø§Ù„Ø®Ù…ÙŠØ³"];
    const LS_KEY="sr-v20-weeks";

    const weeksEl=document.getElementById("weeks");
    document.getElementById("addWeekBtn").addEventListener("click",()=>{state.weeks.push(newWeek()); render();});
    document.getElementById("exportBtn").addEventListener("click",exportPDF);

    // modal refs
    const rowModal=document.getElementById("rowModal");
    const f_day=document.getElementById("f_day");
    const f_date=document.getElementById("f_date");
    const f_grade=document.getElementById("f_grade");
    const f_period=document.getElementById("f_period");
    const f_absent=document.getElementById("f_absent");
    const f_exec=document.getElementById("f_exec");
    const c_basics=document.getElementById("c_basics");
    const c_values=document.getElementById("c_values");
    const c_future=document.getElementById("c_future");
    const saveRowBtn=document.getElementById("saveRowBtn");
    const cancelRowBtn=document.getElementById("cancelRowBtn");
    let editCtx=null;

    let state=load();

    function newWeek(){
      const id="w-"+Date.now()+"-"+Math.random().toString(16).slice(2);
      return {id, teacherName:"", rows:DAYS.slice(1).map(d=>({day:d,date:"",grade:"",period:"",absent:"",executed:"",domain:{b:false,v:false,f:false}})), witnesses:[]};
    }
    function load(){ try{const s=localStorage.getItem(LS_KEY); if(s) return JSON.parse(s);}catch(e){} return {weeks:[newWeek()]}; }
    function save(){ localStorage.setItem(LS_KEY,JSON.stringify(state)); }

    function render(){
      weeksEl.innerHTML="";
      state.weeks.forEach((wk,idx)=>weeksEl.appendChild(renderWeekCard(wk,idx)));
      save();
    }

    function renderWeekCard(wk,idx){
      const sec=document.createElement("section"); sec.className="card";

      // Header (Ø´Ø§Ø´Ø© ÙÙ‚Ø·)
      const h=document.createElement("div"); h.className="card-h no-print";
      const left=document.createElement("div"); left.className="stack";
      const title=document.createElement("div"); title.textContent="Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ #"+(idx+1); title.style.fontWeight="800";
      const teacherBox=document.createElement("div"); teacherBox.className="teacher";
      teacherBox.innerHTML='<label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…Ø©:</label>';
      const inp=document.createElement("input"); inp.value=wk.teacherName||""; inp.addEventListener("input",()=>{wk.teacherName=inp.value; save();});
      teacherBox.appendChild(inp); left.appendChild(title); left.appendChild(teacherBox);
      const right=document.createElement("div"); right.className="stack";
      const addRow=document.createElement("button"); addRow.className="btn btn-primary btn-xs"; addRow.textContent="+ ØµÙ"; addRow.onclick=()=>openRowModal(wk.id,null);
      right.appendChild(addRow);
      if(state.weeks.length>1){ const delW=document.createElement("button"); delW.className="btn btn-danger btn-xs"; delW.textContent="Ø­Ø°Ù Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹"; delW.onclick=()=>{state.weeks=state.weeks.filter(w=>w.id!==wk.id); render();}; right.appendChild(delW); }
      h.appendChild(left); h.appendChild(right); sec.appendChild(h);

      // Body
      const b=document.createElement("div"); b.className="card-b";

      // ğŸ”½ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØªÙØ·Ø¨Ø¹ (ØªØ¸Ù‡Ø± ÙÙŠ Ø§Ù„ØªØµØ¯ÙŠØ± ÙÙ‚Ø·)
      const meta=document.createElement("div");
      meta.className="print-meta print-only";
      meta.innerHTML = '<b>Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ #'+(idx+1)+'</b> â€” Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…Ø©: <b>'+(wk.teacherName?wk.teacherName:'â€”')+'</b>';
      b.appendChild(meta);

      // Ø§Ù„Ø¬Ø¯ÙˆÙ„
      const tWrap=document.createElement("div"); tWrap.className="table-wrap";
      const tbl=document.createElement("table");
      tbl.innerHTML='<thead><tr>'+
        '<th class="col-idx">#</th>'+
        '<th class="col-day">Ø§Ù„ÙŠÙˆÙ…</th>'+
        '<th class="col-date">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>'+
        '<th class="col-grade">Ø§Ù„ØµÙ</th>'+
        '<th class="col-period">Ø§Ù„Ø­ØµØ©</th>'+
        '<th class="col-absent">Ø§Ù„Ù…Ø¹Ù„Ù…Ø© Ø§Ù„ØºØ§Ø¦Ø¨Ø©</th>'+
        '<th>Ù…Ø§ ØªÙ… ØªÙ†ÙÙŠØ°Ù‡</th>'+
        '<th class="col-domain">Ø§Ù„Ù…Ø¬Ø§Ù„</th>'+
        '<th class="col-actions">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>'+
      '</tr></thead><tbody></tbody>';
      const tb=tbl.querySelector("tbody");

      wk.rows.forEach((r,i)=>{
        const tr=document.createElement("tr");
        tr.appendChild(td(i+1));
        tr.appendChild(td(r.day||""));
        tr.appendChild(td(r.date||""));
        tr.appendChild(td(r.grade||""));
        tr.appendChild(td(r.period||""));
        tr.appendChild(td(r.absent||""));
        tr.appendChild(td(r.executed||""));
        tr.appendChild(td(domainText(r.domain)));
        const act=document.createElement("td"); act.className="col-actions";
        const s=document.createElement("div"); s.className="stack";
        const ebtn=document.createElement("button"); ebtn.className="btn btn-ghost btn-xs"; ebtn.textContent="Ø¥Ø¶Ø§ÙØ©"; ebtn.onclick=()=>openRowModal(wk.id,i);
        const dbtn=document.createElement("button"); dbtn.className="btn btn-danger btn-xs"; dbtn.textContent="Ø­Ø°Ù"; dbtn.onclick=()=>{wk.rows.splice(i,1); render();};
        s.appendChild(ebtn); s.appendChild(dbtn); act.appendChild(s); tr.appendChild(act);
        tb.appendChild(tr);
      });

      tWrap.appendChild(tbl); b.appendChild(tWrap);

      // Ø§Ù„Ø´ÙˆØ§Ù‡Ø¯
      const wBox=document.createElement("div"); wBox.className="witness";
      const titleW=document.createElement("h4"); titleW.textContent="Ø§Ù„Ø´ÙˆØ§Ù‡Ø¯"; wBox.appendChild(titleW);
      const grid=document.createElement("div"); grid.className="w-grid";
      for(let i=0;i<3;i++){
        const slot=document.createElement("div"); slot.className="slot";
        if(wk.witnesses[i]){ const img=document.createElement("img"); img.src=wk.witnesses[i]; slot.appendChild(img); }
        else{ slot.classList.add("empty"); }
        grid.appendChild(slot);
      }
      wBox.appendChild(grid);

      const wActions=document.createElement("div"); wActions.className="w-actions no-print";
      const inpFile=document.createElement("input"); inpFile.type="file"; inpFile.accept="image/*"; inpFile.multiple=true;
      inpFile.onchange=(e)=>{ const files=[...e.target.files].slice(0,3);
        wk.witnesses=[];
        const readers=files.map(f=>new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(f); }));
        Promise.all(readers).then(urls=>{ wk.witnesses=urls.slice(0,3); render(); });
      };
      const clrBtn=document.createElement("button"); clrBtn.className="btn btn-ghost btn-xs"; clrBtn.textContent="Ù…Ø³Ø­ Ø§Ù„Ø´ÙˆØ§Ù‡Ø¯"; clrBtn.onclick=()=>{wk.witnesses=[]; render();};
      wActions.appendChild(inpFile); wActions.appendChild(clrBtn);
      wBox.appendChild(wActions);

      b.appendChild(wBox);
      sec.appendChild(b);
      return sec;
    }

    function td(t){const d=document.createElement("td"); d.textContent=t; return d;}
    function domainText(d){const a=[]; if(d&&d.b)a.push("Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©"); if(d&&d.v)a.push("Ø§Ù„Ù‚ÙŠÙ… ÙˆØ§Ù„Ù…ÙˆØ§Ø·Ù†Ø© Ø§Ù„ØµØ§Ù„Ø­Ø©"); if(d&&d.f)a.push("Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„"); return a.length?a.join("ØŒ "):"â€”";}

    function openRowModal(weekId,idx){
      editCtx={weekId,idx};
      const wk=state.weeks.find(w=>w.id===weekId);
      const r=(idx==null)?{day:"",date:"",grade:"",period:"",absent:"",executed:"",domain:{b:false,v:false,f:false}}:wk.rows[idx];
      f_day.value=r.day||""; f_date.value=r.date||""; f_grade.value=r.grade||""; f_period.value=r.period||"";
      f_absent.value=r.absent||""; f_exec.value=r.executed||"";
      c_basics.checked=!!(r.domain&&r.domain.b); c_values.checked=!!(r.domain&&r.domain.v); c_future.checked=!!(r.domain&&r.domain.f);
      rowModal.style.display="flex";
    }
    function closeRow(){rowModal.style.display="none"; editCtx=null;}
    cancelRowBtn.onclick=closeRow;
    saveRowBtn.onclick=function(){
      if(!editCtx) return;
      const wk=state.weeks.find(w=>w.id===editCtx.weekId);
      const obj={day:f_day.value,date:f_date.value,grade:f_grade.value,period:f_period.value,absent:f_absent.value,executed:f_exec.value,domain:{b:c_basics.checked,v:c_values.checked,f:c_future.checked}};
      if(editCtx.idx==null) wk.rows.push(obj); else wk.rows[editCtx.idx]=obj;
      save(); render(); closeRow();
    };

    async function exportPDF(){
      const { jsPDF } = window.jspdf;
      const area=document.getElementById("exportArea");
      const banner=document.getElementById("printBanner");
      const sandbox=document.createElement("div");
      sandbox.id="printSandbox"; document.body.appendChild(sandbox);

      const cards=[...area.querySelectorAll(".card")];

      // ØµÙØ­Ø© 1: Ø§Ù„Ø¯ÙŠØ¨Ø§Ø¬Ø© + Ø£ÙˆÙ„ Ø£Ø³Ø¨ÙˆØ¹
      const first=document.createElement("div"); first.className="sheet";
      first.appendChild(banner.cloneNode(true));
      if(cards[0]) first.appendChild(cleanForExport(cards[0].cloneNode(true)));
      sandbox.appendChild(first);

      // Ø¨Ù‚ÙŠØ© Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹
      for(let i=1;i<cards.length;i++){
        const s=document.createElement("div"); s.className="sheet";
        s.appendChild(cleanForExport(cards[i].cloneNode(true)));
        sandbox.appendChild(s);
      }

      document.body.classList.add("exporting");

      const pdf=new jsPDF("l","mm","a4");
      const pageW=297; const scale=1.2;
      let firstPage=true;
      for(const page of sandbox.children){
        const canvas=await html2canvas(page,{scale:scale,backgroundColor:"#ffffff",useCORS:true,windowWidth:1200});
        const img=canvas.toDataURL("image/jpeg",0.92);
        const imgH=(canvas.height*pageW)/canvas.width;
        if(!firstPage) pdf.addPage();
        pdf.addImage(img,"JPEG",0,0,pageW,imgH,undefined,"FAST");
        firstPage=false;
      }

      document.body.classList.remove("exporting");
      sandbox.remove();

      try{
        const blob=pdf.output("blob");
        const url=URL.createObjectURL(blob);
        const win=window.open(url,"_blank");
        if(!win){ pdf.save("ØªÙ‚Ø±ÙŠØ±-Ø­ØµØµ-Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±.pdf"); }
        setTimeout(()=>{ try{URL.revokeObjectURL(url);}catch(e){} }, 5*60*1000);
      }catch(e){
        pdf.save("ØªÙ‚Ø±ÙŠØ±-Ø­ØµØµ-Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±.pdf");
      }
    }

    // ØªÙ†Ø¸ÙŠÙ Ù†Ø³Ø®Ø© Ø§Ù„ØªØµØ¯ÙŠØ±:
    function cleanForExport(card){
      // Ø§Ø­Ø°Ù Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§
      card.querySelectorAll('th.col-actions, td.col-actions').forEach(el=>el.remove());
      // Ø§Ø­Ø°Ù Ø£Ø¯ÙˆØ§Øª Ø±ÙØ¹ Ø§Ù„Ø´ÙˆØ§Ù‡Ø¯
      card.querySelectorAll('.w-actions').forEach(el=>el.remove());
      // Ø§Ø®ÙÙ Ø§Ù„Ø®Ø§Ù†Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ© (Ù„Ùˆ ØµÙˆØ±ØªÙŠÙ† ÙÙ‚Ø· Ù„Ø§ ÙŠØ¸Ù‡Ø± Ø§Ù„Ø«Ø§Ù„Ø«)
      card.querySelectorAll('.w-grid .slot.empty').forEach(el=>el.remove());
      // Ø¥Ù† Ù„Ù… ØªØ¨Ù‚ Ø£ÙŠ ØµÙˆØ±Ø©ØŒ Ø§Ø­Ø°Ù Ù‚Ø³Ù… Ø§Ù„Ø´ÙˆØ§Ù‡Ø¯
      const w=card.querySelector('.witness');
      if(w && w.querySelectorAll('img').length===0){ w.remove(); }
      return card;
    }

    render();
  })();
  </script>
</body>
</html>
