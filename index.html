<!doctype html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>تقرير حصص الانتظار – الثانوية السادسة والعشرون (تبوك)</title>

    <!-- Tailwind عبر CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React 18 UMD -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Babel لتشغيل JSX على GitHub Pages -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- مكتبات PDF (UMD) -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

    <meta name="color-scheme" content="light dark" />
    <style>
      :root{
        /* أخضر فاتح قريب من هوية وزارة التعليم */
        --accent:#69bf97;       /* للأزرار */
        --accent-dark:#46a87d;
        --border:#d8e5dc;       /* حدود الجدول */
        --ink:#0f172a;
        --paper:#ffffff;
        --banner-bg:#e8f6ef;    /* خلفية الديباجة */
        --banner-ink:#116e4f;   /* نص الديباجة */
      }
      body{background:#f6faf8;color:var(--ink);}
      table{border-collapse:collapse;width:100%;}
      thead th{position:sticky;top:0;z-index:1;background:var(--paper);}
      th,td{border:1px solid var(--border);}
      /* طباعة: نُظهر فقط الديباجة + الجداول (نخفي أي عنصر بعلامة print-hide) */
      @media print{ .print-hide{display:none!important;} body{background:#fff!important;} }
    </style>
  </head>
  <body>
    <!-- ديباجة علوية (زر التصدير لن يُطبع) -->
    <div class="rounded-none md:rounded-2xl mx-auto my-3 md:my-6 max-w-6xl border print-hide"
         style="background:var(--banner-bg);color:var(--banner-ink);border-color:var(--border);">
      <div class="px-4 py-4 md:px-6 md:py-5 flex items-center justify-between">
        <div class="text-base md:text-lg font-bold">الثانوية السادسة والعشرون - تبوك</div>
        <button id="exportBtn" onclick="window.__exportPDF && window.__exportPDF()"
                class="px-3 py-2 rounded-xl text-sm font-semibold"
                style="background:var(--accent);color:#fff;">تصدير PDF</button>
      </div>
    </div>

    <!-- React mount -->
    <div id="root"></div>

    <!-- تذليل (لا يُطبع) -->
    <footer class="print-hide max-w-6xl mx-auto mt-8 mb-10 text-sm text-slate-600">
      <div class="border-t pt-3" style="border-color:var(--border)">
        <div>مديرة المدرسة: <strong>أماني آل عبشان</strong></div>
        <div>تصميم الهيئة الإدارية: <strong>عيدة صلاح</strong>، <strong>منيرة العمراني</strong></div>
      </div>
    </footer>

    <!-- ملاحظة مهمة: نحدد الـpresets للـBabel عشان JSX يشتغل على Pages -->
    <script type="text/babel" data-presets="env,react">
      /* ===== مكونات صغيرة ===== */
      const Th = ({ children, className = "" }) => (
        <th className={`text-right px-3 py-2 text-xs font-semibold ${className}`}>{children}</th>
      );
      const Td = ({ children, className = "" }) => (
        <td className={`px-2 py-2 align-top ${className}`}>{children}</td>
      );
      const InlineInput = ({ value, onChange, aria }) => (
        <input aria-label={aria} value={value} onChange={(e)=>onChange(e.target.value)}
               className="border-b outline-none px-1 py-0.5 rounded-sm"
               style={{ borderColor: "var(--border)" }} />
      );
      const Select = ({ value, onChange, options, aria }) => (
        <select aria-label={aria} value={value} onChange={(e)=>onChange(e.target.value)}
                className="w-full border rounded-lg px-2 py-1"
                style={{ borderColor: "var(--border)" }}>
          {options.map((op,i)=>(<option key={i} value={op}>{op}</option>))}
        </select>
      );
      const Check = ({ label, checked, onChange }) => (
        <label className="flex items-center gap-2 text-xs">
          <input type="checkbox" checked={checked} onChange={(e)=>onChange(e.target.checked)} />
          <span>{label}</span>
        </label>
      );

      /* ===== بيانات ===== */
      const DAYS = ["الأحد","الاثنين","الثلاثاء","الأربعاء","الخميس"];
      const emptyRow = () => ({ day:"", date:"", grade:"", period:"", absentTeacher:"", executed:"", witness:"", domain:{ basics:false, values:false, future:false } });
      const newWeek = () => ({
        id:`week-${Date.now()}`,
        title:"تقرير تنفيذ حصص الانتظار – الأسبوع",
        teacherName:"",
        rows:Array.from({length:5}, (_,i)=>({ ...emptyRow(), day:DAYS[i] })),
      });

      function App(){
        const [weeks, setWeeks] = React.useState(()=>{
          const saved = localStorage.getItem("report-weeks-pages");
          if(saved){ try{ return JSON.parse(saved); } catch{ return [newWeek()]; } }
          return [newWeek()];
        });

        const printAreaRef = React.useRef(null);
        React.useEffect(()=>{ localStorage.setItem("report-weeks-pages", JSON.stringify(weeks)); },[weeks]);

        const addWeek    = ()=> setWeeks(w=>[...w, newWeek()]);
        const removeWeek = (id)=> setWeeks(w=>w.filter(x=>x.id!==id));
        const addRow     = (id)=> setWeeks(w=>w.map(x=>x.id===id?{...x, rows:[...x.rows, emptyRow()]}:x));
        const removeRow  = (id, idx)=> setWeeks(w=>w.map(x=>x.id===id?{...x, rows:x.rows.filter((_,i)=>i!==idx)}:x));
        const setWeekField = (id, field, value)=> setWeeks(w=>w.map(x=>x.id===id?{...x, [field]:value}:x));
        const setCell = (id, idx, path, value)=> {
          setWeeks(w=>w.map(week=>{
            if(week.id!==id) return week;
            const rows=[...week.rows];
            const row={...rows[idx]};
            if(path.startsWith("domain.")){
              const key = path.split(".")[1];
              row.domain = {...row.domain, [key]: value};
            }else{
              row[path] = value;
            }
            rows[idx]=row;
            return {...week, rows};
          }));
        };

        // تصدير PDF: يلتقط الديباجة + الجداول فقط
        const exportPDF = async ()=>{
          const area = printAreaRef.current;
          if(!area) return;
          const clone = area.cloneNode(true);
          clone.style.maxWidth = "794px"; // عرض A4 تقريبي
          const canvas = await window.html2canvas(clone, { scale:2, useCORS:true });
          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF("p","mm","a4");
          const img = canvas.toDataURL("image/jpeg", 0.95);
          const pageW=210, pageH=297;
          const imgW=pageW, imgH=(canvas.height*imgW)/canvas.width;
          let heightLeft=imgH, pos=0;
          pdf.addImage(img,"JPEG",0,pos,imgW,imgH,undefined,"FAST");
          heightLeft -= pageH;
          while(heightLeft>0){
            pos = heightLeft - imgH;
            pdf.addPage();
            pdf.addImage(img,"JPEG",0,pos,imgW,imgH,undefined,"FAST");
            heightLeft -= pageH;
          }
          pdf.save("تقرير-حصص-الانتظار.pdf");
        };
        // اجعل الدالة متاحة للزر العلوي
        window.__exportPDF = exportPDF;

        return (
          <div className="p-4 md:p-6">
            <div className="max-w-6xl mx-auto space-y-6">
              {/* أدوات عامة (لا تُطبع) */}
              <div className="print-hide flex items-center justify-between gap-3">
                <button onClick={addWeek}
                        className="px-3 py-2 rounded-xl text-sm font-semibold text-white"
                        style={{ background:"var(--accent)" }}>
                  إضافة أسبوع
                </button>
              </div>

              {/* منطقة التصدير/الطباعة: ديباجة للطباعة + الجداول */}
              <div ref={printAreaRef} className="space-y-4">
                <div className="rounded-2xl border"
                     style={{ background:"var(--banner-bg)", color:"var(--banner-ink)", borderColor:"var(--border)" }}>
                  <div className="px-4 py-4 md:px-6 md:py-5">
                    <div className="text-base md:text-lg font-bold">الثانوية السادسة والعشرون - تبوك</div>
                  </div>
                </div>

                {weeks.map((wk)=>(
                  <section key={wk.id}
                           className="bg-white rounded-2xl border overflow-hidden"
                           style={{ borderColor:"var(--border)" }}>
                    {/* اسم المعلمة + أزرار الأسبوع — لا تُطبع */}
                    <div className="print-hide flex flex-wrap items-center justify-between gap-3 p-4 border-b"
                         style={{ borderColor:"var(--border)" }}>
                      <div className="flex items-center gap-3">
                        <span className="text-sm text-slate-700">اسم المعلمة:</span>
                        <InlineInput aria="اسم المعلمة" value={wk.teacherName || ""} onChange={(v)=>setWeekField(wk.id,"teacherName",v)} />
                      </div>
                      <div className="flex items-center gap-2">
                        <button onClick={()=>addRow(wk.id)}
                                className="px-3 py-2 rounded-xl text-xs font-semibold text-white"
                                style={{ background:"var(--accent)" }}>+ صف</button>
                        {weeks.length>1 && (
                          <button onClick={()=>removeWeek(wk.id)}
                                  className="px-3 py-2 rounded-xl text-xs font-semibold"
                                  style={{ background:"var(--accent-dark)", color:"#fff" }}>حذف الأسبوع</button>
                        )}
                      </div>
                    </div>

                    {/* الجدول: حدود واضحة فقط */}
                    <div className="p-4">
                      <table className="text-sm bg-white">
                        <thead>
                          <tr>
                            <Th>#</Th>
                            <Th>اليوم</Th>
                            <Th>التاريخ</Th>
                            <Th>الصف</Th>
                            <Th>الحصة</Th>
                            <Th>المعلمة الغائبة</Th>
                            <Th>ما تم تنفيذه</Th>
                            <Th>الشاهد</Th>
                            <Th>المجال</Th>
                            <Th className="print-hide">إجراءات</Th>
                          </tr>
                        </thead>
                        <tbody>
                          {wk.rows.map((r, idx)=>(
                            <tr key={idx}>
                              <Td className="text-slate-500">{idx+1}</Td>
                              <Td>
                                <Select aria="اليوم" value={r.day} onChange={(v)=>setCell(wk.id, idx, "day", v)}
                                        options={["","الأحد","الاثنين","الثلاثاء","الأربعاء","الخميس"]} />
                              </Td>
                              <Td><input aria-label="التاريخ" type="date" value={r.date}
                                         onChange={(e)=>setCell(wk.id, idx, "date", e.target.value)}
                                         className="w-full border rounded-lg px-2 py-1" style={{ borderColor:"var(--border)" }}/></Td>
                              <Td><input aria-label="الصف" value={r.grade}
                                         onChange={(e)=>setCell(wk.id, idx, "grade", e.target.value)}
                                         className="w-full border rounded-lg px-2 py-1" style={{ borderColor:"var(--border)" }}/></Td>
                              <Td><input aria-label="الحصة" value={r.period}
                                         onChange={(e)=>setCell(wk.id, idx, "period", e.target.value)}
                                         className="w-full border rounded-lg px-2 py-1" style={{ borderColor:"var(--border)" }}/></Td>
                              <Td><input aria-label="المعلمة الغائبة" value={r.absentTeacher}
                                         onChange={(e)=>setCell(wk.id, idx, "absentTeacher", e.target.value)}
                                         className="w-full border rounded-lg px-2 py-1" style={{ borderColor:"var(--border)" }}/></Td>
                              <Td><textarea aria-label="ما تم تنفيذه" value={r.executed}
                                            onChange={(e)=>setCell(wk.id, idx, "executed", e.target.value)}
                                            className="w-full border rounded-lg px-2 py-1 min-h-[44px]" style={{ borderColor:"var(--border)" }}></textarea></Td>
                              <Td><textarea aria-label="الشاهد" value={r.witness}
                                            onChange={(e)=>setCell(wk.id, idx, "witness", e.target.value)}
                                            className="w-full border rounded-lg px-2 py-1 min-h-[44px]" style={{ borderColor:"var(--border)" }}></textarea></Td>
                              <Td>
                                <div className="space-y-1">
                                  <Check label="المهارات الأساسية" checked={r.domain.basics} onChange={(v)=>setCell(wk.id, idx, "domain.basics", v)} />
                                  <Check label="القيم والمواطنة الصالحة" checked={r.domain.values} onChange={(v)=>setCell(wk.id, idx, "domain.values", v)} />
                                  <Check label="مهارات المستقبل" checked={r.domain.future} onChange={(v)=>setCell(wk.id, idx, "domain.future", v)} />
                                </div>
                              </Td>
                              <Td className="print-hide">
                                <button onClick={()=>removeRow(wk.id, idx)}
                                        className="px-2 py-1 rounded-lg text-xs text-white"
                                        style={{ background:"var(--accent)" }}>حذف</button>
                              </Td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </section>
                ))}
              </div>
            </div>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
