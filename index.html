<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>تقرير حصص الانتظار – الثانوية السادسة والعشرون (تبوك)</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet" />
  <style>
    :root{
      --primary:#28a745; --primary-dark:#1e7e34;
      --ink:#263b33; --ink-soft:#4b6a5d;
      --border:#e3ece6; --border-2:#d8e5dc;
      --paper:#fff; --page:#f6faf8;
      --banner-bg:#e8f6ef; --banner-ink:#116e4f;
      --shadow:0 6px 22px rgba(0,0,0,.06);
      --shadow-green:0 10px 30px rgba(40,167,69,.15);
      --shadow-soft:0 2px 10px rgba(0,0,0,.04);
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--page);color:var(--ink);
      font-family:"Tajawal",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;line-height:1.75}

    /* حاوية عامة */
    .container{max-width:1180px;margin:20px auto;padding:0 16px}

    /* ديباجة */
    .banner{background:var(--banner-bg);color:var(--banner-ink);border:1px solid var(--border);
      border-radius:20px;padding:20px 22px;display:flex;align-items:center;justify-content:space-between;gap:12px;
      box-shadow:var(--shadow-green);margin-bottom:12px}
    .title{font-weight:800;font-size:1.6rem;text-align:center;flex:1}

    .btn{appearance:none;border:0;border-radius:12px;padding:11px 16px;font-weight:800;cursor:pointer;display:inline-flex;align-items:center;gap:8px}
    .btn-primary{background:var(--primary);color:#fff;box-shadow:0 8px 22px rgba(40,167,69,.20)}
    .btn-primary:hover{background:var(--primary-dark)}
    .btn-ghost{background:#fff;border:1px solid var(--border);color:#204c3d}
    .btn-danger{background:#fee2e2;color:#b91c1c;border:1px solid #fecaca}
    .stack{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

    /* بطاقات */
    .card{background:#fff;border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);overflow:hidden}
    .card + .card{margin-top:16px}
    .card-h{padding:14px 16px;border-bottom:1px solid var(--border);
      display:flex;align-items:center;justify-content:space-between;gap:12px;background:linear-gradient(180deg,#fbfdfc,#fff)}
    .card-b{padding:16px}

    .teacher{display:flex;align-items:center;gap:10px}
    .teacher label{color:var(--ink-soft);font-weight:700;white-space:nowrap}
    .teacher input{min-width:260px;border:1px solid var(--border-2);border-radius:10px;padding:10px 14px;text-align:center;outline:0}
    .teacher input:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(40,167,69,.10)}

    /* جدول: شاشة */
    .table-wrap{
      border:1px solid var(--border);border-top:0;border-radius:0 0 16px 16px;overflow:auto;
      box-shadow:var(--shadow-soft);position:relative
    }
    /* تلميح تمرير للجوال */
    .table-wrap::after{
      content:"↔ اسحب أفقياً"; position:absolute; top:8px; left:12px; font-size:.85rem; color:#89a093;
    }
    table{border-collapse:separate;border-spacing:0;width:100%;background:var(--paper);table-layout:auto}
    thead th{
      position:sticky;top:0;z-index:2;background:linear-gradient(180deg,#e9f7ef,#f6fbf8);
      color:#1d6a4f;font-weight:800;border-bottom:1px solid var(--border);text-align:center;white-space:nowrap
    }
    th,td{
      border-right:1px solid var(--border);border-bottom:1px solid var(--border);
      padding:12px 10px;text-align:center;vertical-align:middle;white-space:nowrap;overflow:hidden;text-overflow:ellipsis
    }
    th:first-child,td:first-child{border-right:none}
    tbody tr:nth-child(even) td{background:#fbfdfc}
    tbody tr:hover td{background:#f4faf6}
    .week-title{font-weight:800;color:#2b6f57}
    .tags{display:flex;gap:6px;justify-content:center;flex-wrap:wrap;white-space:normal}
    .tag{border:1px solid var(--border-2);background:#f7faf8;padding:4px 8px;border-radius:999px;font-size:.9rem;color:#2a5d4c}

    /* عرض أعمدة منضبط */
    th.col-idx{width:48px}
    th.col-day{width:110px}
    th.col-date{width:150px}
    th.col-grade{width:120px}
    th.col-period{width:120px}
    th.col-absent{width:180px}
    th.col-domain{width:210px}
    th.col-actions{width:180px}

    /* تذييل */
    .footer{margin-top:18px;background:var(--banner-bg);color:var(--banner-ink);border:1px solid var(--border);
      border-radius:18px;padding:14px 16px;text-align:center;box-shadow:var(--shadow-green)}

    /* طباعة/تصدير */
    .no-print{display:initial} .print-only{display:none}
    .exporting .no-print{display:none!important} .exporting .print-only{display:block!important}
    .pdf-slim *{box-shadow:none!important}

    @media print{
      @page{size:A4 landscape; margin:10mm}
      body{background:#fff!important}
      .card{page-break-after:always}
      thead th{background:#eaeaea!important;color:#000!important;-webkit-print-color-adjust:exact;print-color-adjust:exact}
      th,td{border:1px solid #000!important;white-space:normal}
      .table-wrap::after{content:none}
    }

    /* جوال */
    @media (max-width:640px){
      .container{padding:0 12px}
      .banner{flex-direction:column;align-items:center;text-align:center;gap:12px}
      .banner .title{font-size:1.35rem}
      .banner .stack{width:100%;justify-content:center}
      .card-h{flex-direction:column;align-items:stretch;gap:10px}
      .teacher{justify-content:center}
      .teacher input{min-width:0;width:100%}

      /* الجدول على الجوال: سحب أفقي + تصغير الخط + إخفاء الإجراءات */
      .table-wrap{border-radius:0 0 14px 14px;overflow-x:auto;-webkit-overflow-scrolling:touch}
      table{min-width:980px} /* يضمن ظهور كل الأعمدة بدون ضغط */
      thead th{font-size:.92rem}
      th,td{padding:10px 8px;font-size:.92rem}
      th.col-actions, td.col-actions{display:none}
      .table-wrap::after{left:10px;top:6px;font-size:.8rem}
    }

    /* Sandbox خفي للتصدير */
    #printSandbox{position:fixed;left:-99999px;top:0;width:1200px;background:#fff;pointer-events:none;opacity:0}
    #printSandbox .sheet{margin:0 0 18px 0;border:1px solid #eee;border-radius:12px}
    #printSandbox .sheet .card{border-radius:0;box-shadow:none;border:0}
    #printSandbox .sheet .card-h{border-bottom:1px solid #ddd}
  </style>

  <!-- مكتبات التصدير -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body>
  <div class="container">
    <!-- ديباجة -->
    <div class="banner no-print">
      <div class="title">الثانوية السادسة والعشرون - تبوك</div>
      <div class="stack">
        <button id="addWeekBtn" class="btn btn-primary">إضافة أسبوع</button>
        <button id="exportBtn" class="btn btn-primary">تصدير PDF</button>
      </div>
    </div>

    <!-- منطقة التصدير -->
    <div id="exportArea" style="margin-top:14px">
      <div class="banner print-only" id="printBanner" style="box-shadow:var(--shadow-green)">
        <div class="title">الثانوية السادسة والعشرون - تبوك</div>
      </div>
      <div id="weeks"></div>
    </div>

    <!-- تذييل -->
    <div class="footer no-print">
      <div>مديرة المدرسة: <strong>أماني آل عبشان</strong></div>
      <div>تصميم الهيئة الإدارية: <strong>عيدة صلاح</strong>، <strong>منيرة العمراني</strong></div>
    </div>
  </div>

  <!-- نافذة إدخال صف -->
  <div id="rowModal" class="modal no-print" style="position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:16px;z-index:50">
    <div class="modal-card" style="background:#fff;border-radius:18px;box-shadow:var(--shadow);max-width:760px;width:100%;overflow:hidden;border:1px solid var(--border)">
      <div class="modal-h" style="padding:14px 16px;border-bottom:1px solid var(--border);font-weight:800;color:#2b6f57">إدخال بيانات الصف</div>
      <div class="modal-b" style="padding:16px">
        <div class="grid" style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px">
          <div class="field"><label>اليوم</label>
            <select id="f_day" style="border:1px solid var(--border-2);border-radius:10px;padding:10px 12px;text-align:center;outline:0">
              <option value=""></option><option>الأحد</option><option>الاثنين</option><option>الثلاثاء</option><option>الأربعاء</option><option>الخميس</option>
            </select>
          </div>
          <div class="field"><label>التاريخ</label><input id="f_date" type="date" style="border:1px solid var(--border-2);border-radius:10px;padding:10px 12px;text-align:center;outline:0"></div>
          <div class="field"><label>الصف</label><input id="f_grade" style="border:1px solid var(--border-2);border-radius:10px;padding:10px 12px;text-align:center;outline:0"></div>
          <div class="field"><label>الحصة</label><input id="f_period" style="border:1px solid var(--border-2);border-radius:10px;padding:10px 12px;text-align:center;outline:0"></div>
          <div class="field"><label>المعلمة الغائبة</label><input id="f_absent" style="border:1px solid var(--border-2);border-radius:10px;padding:10px 12px;text-align:center;outline:0"></div>
          <div class="field" style="grid-column:1/-1"><label>ما تم تنفيذه</label><textarea id="f_exec" style="border:1px solid var(--border-2);border-radius:10px;padding:10px 12px;min-height:70px;text-align:right;outline:0"></textarea></div>
          <div class="field" style="grid-column:1/-1"><label>الشاهد</label><textarea id="f_witness" style="border:1px solid var(--border-2);border-radius:10px;padding:10px 12px;min-height:70px;text-align:right;outline:0"></textarea></div>
          <div class="field" style="grid-column:1/-1">
            <label>المجال</label>
            <div class="checks" style="display:flex;gap:8px;flex-wrap:wrap">
              <label style="display:flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:10px;padding:8px 10px;background:#f7faf8"><input type="checkbox" id="c_basics"> المهارات الأساسية</label>
              <label style="display:flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:10px;padding:8px 10px;background:#f7faf8"><input type="checkbox" id="c_values"> القيم والمواطنة الصالحة</label>
              <label style="display:flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:10px;padding:8px 10px;background:#f7faf8"><input type="checkbox" id="c_future"> مهارات المستقبل</label>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-f" style="display:flex;gap:10px;justify-content:flex-start;padding:14px 16px">
        <button id="saveRowBtn" class="btn btn-primary">حفظ</button>
        <button id="cancelRowBtn" class="btn btn-ghost">إلغاء</button>
      </div>
    </div>
  </div>

  <script>
  (function(){
    var DAYS=["","الأحد","الاثنين","الثلاثاء","الأربعاء","الخميس"];
    var LS_KEY="sr-v9-weeks";
    var weeksEl=document.getElementById("weeks");
    var addWeekBtn=document.getElementById("addWeekBtn");
    var exportBtn=document.getElementById("exportBtn");

    var rowModal=document.getElementById("rowModal");
    var f_day=document.getElementById("f_day");
    var f_date=document.getElementById("f_date");
    var f_grade=document.getElementById("f_grade");
    var f_period=document.getElementById("f_period");
    var f_absent=document.getElementById("f_absent");
    var f_exec=document.getElementById("f_exec");
    var f_witness=document.getElementById("f_witness");
    var c_basics=document.getElementById("c_basics");
    var c_values=document.getElementById("c_values");
    var c_future=document.getElementById("c_future");
    var saveRowBtn=document.getElementById("saveRowBtn");
    var cancelRowBtn=document.getElementById("cancelRowBtn");

    var state=load();
    var editCtx=null;

    function load(){
      try{var s=localStorage.getItem(LS_KEY);if(s) return JSON.parse(s);}catch(e){}
      return {weeks:[newWeek()]};
    }
    function save(){localStorage.setItem(LS_KEY,JSON.stringify(state));}
    function newWeek(){
      var id="w-"+Date.now()+"-"+Math.random().toString(16).slice(2);
      return {id:id,teacherName:"",title:"الأسبوع",
        rows:DAYS.slice(1).map(function(d){return {day:d,date:"",grade:"",period:"",absent:"",executed:"",witness:"",domain:{b:false,v:false,f:false}};})};
    }

    function render(){
      weeksEl.innerHTML="";
      for(var w=0;w<state.weeks.length;w++){weeksEl.appendChild(renderWeekCard(state.weeks[w],w));}
      save();
    }

    function renderWeekCard(wk,wIdx){
      var wrap=document.createElement("section"); wrap.className="card"; wrap.style.marginTop="16px";
      var h=document.createElement("div"); h.className="card-h no-print";
      var left=document.createElement("div"); left.className="stack";
      var title=document.createElement("div"); title.className="week-title"; title.textContent=wk.title+" #"+(wIdx+1); left.appendChild(title);
      var teacherBox=document.createElement("div"); teacherBox.className="teacher";
      var label=document.createElement("label"); label.textContent="اسم المعلمة:"; var input=document.createElement("input");
      input.value=wk.teacherName||""; input.addEventListener("input",function(){wk.teacherName=input.value;save();});
      teacherBox.appendChild(label); teacherBox.appendChild(input); left.appendChild(teacherBox);
      var right=document.createElement("div"); right.className="stack";
      var addRowBtn=document.createElement("button"); addRowBtn.className="btn btn-primary"; addRowBtn.textContent="+ صف";
      addRowBtn.addEventListener("click",function(){openRowModal(wk.id,null);}); right.appendChild(addRowBtn);
      if(state.weeks.length>1){var delWeek=document.createElement("button"); delWeek.className="btn btn-danger"; delWeek.textContent="حذف الأسبوع";
        delWeek.addEventListener("click",function(){state.weeks=state.weeks.filter(function(x){return x.id!==wk.id});render();}); right.appendChild(delWeek);}
      h.appendChild(left); h.appendChild(right); wrap.appendChild(h);

      var b=document.createElement("div"); b.className="card-b";
      var tableWrap=document.createElement("div"); tableWrap.className="table-wrap";
      var table=document.createElement("table");
      table.innerHTML='<thead><tr>'+
        '<th class="col-idx">#</th>'+
        '<th class="col-day">اليوم</th>'+
        '<th class="col-date">التاريخ</th>'+
        '<th class="col-grade">الصف</th>'+
        '<th class="col-period">الحصة</th>'+
        '<th class="col-absent">المعلمة الغائبة</th>'+
        '<th>ما تم تنفيذه</th>'+
        '<th>الشاهد</th>'+
        '<th class="col-domain">المجال</th>'+
        '<th class="col-actions no-print">إجراءات</th>'+
      '</tr></thead><tbody></tbody>';
      var tbody=table.querySelector("tbody");
      if(!wk.rows||!wk.rows.length){wk.rows=DAYS.slice(1).map(function(d){return {day:d,date:"",grade:"",period:"",absent:"",executed:"",witness:"",domain:{b:false,v:false,f:false}};});}

      for(var i=0;i<wk.rows.length;i++){
        (function(iCopy){
          var r=wk.rows[iCopy];
          var tr=document.createElement("tr");
          tr.appendChild(tdText(iCopy+1));
          tr.appendChild(tdText(r.day||""));
          tr.appendChild(tdText(r.date||""));
          tr.appendChild(tdText(r.grade||""));
          tr.appendChild(tdText(r.period||""));
          tr.appendChild(tdText(r.absent||""));
          tr.appendChild(tdText(r.executed||""));
          tr.appendChild(tdText(r.witness||""));
          var domTd=document.createElement("td"); domTd.appendChild(renderTags(r.domain)); tr.appendChild(domTd);

          var act=document.createElement("td"); act.className="col-actions no-print";
          var edit=document.createElement("button"); edit.className="btn btn-ghost"; edit.textContent="إضافة"; edit.addEventListener("click",function(){openRowModal(wk.id,iCopy);});
          var del=document.createElement("button"); del.className="btn btn-danger"; del.textContent="حذف"; del.addEventListener("click",function(){wk.rows.splice(iCopy,1);render();});
          var stack=document.createElement("div"); stack.className="stack"; stack.appendChild(edit); stack.appendChild(del); act.appendChild(stack); tr.appendChild(act);
          tbody.appendChild(tr);
        })(i);
      }
      tableWrap.appendChild(table); b.appendChild(tableWrap); wrap.appendChild(b);
      return wrap;
    }

    function tdText(t){var td=document.createElement("td"); td.textContent=t; return td;}
    function renderTags(domain){
      var wrap=document.createElement("div"); wrap.className="tags";
      var arr=[];
      if(domain&&domain.b) arr.push("المهارات الأساسية");
      if(domain&&domain.v) arr.push("القيم والمواطنة الصالحة");
      if(domain&&domain.f) arr.push("مهارات المستقبل");
      if(!arr.length){wrap.textContent="—";return wrap;}
      arr.forEach(function(x){var s=document.createElement("span"); s.className="tag"; s.textContent=x; wrap.appendChild(s);});
      return wrap;
    }

    function openRowModal(weekId,idx){
      editCtx={weekId:weekId,idx:idx};
      var wk=state.weeks.find(function(w){return w.id===weekId});
      var r=(idx==null)?{day:"",date:"",grade:"",period:"",absent:"",executed:"",witness:"",domain:{b:false,v:false,f:false}}:wk.rows[idx];
      f_day.value=r.day||""; f_date.value=r.date||""; f_grade.value=r.grade||""; f_period.value=r.period||"";
      f_absent.value=r.absent||""; f_exec.value=r.executed||""; f_witness.value=r.witness||"";
      c_basics.checked=!!(r.domain&&r.domain.b); c_values.checked=!!(r.domain&&r.domain.v); c_future.checked=!!(r.domain&&r.domain.f);
      rowModal.style.display="flex";
    }
    function closeRowModal(){rowModal.style.display="none"; editCtx=null;}
    saveRowBtn.addEventListener("click",function(){
      if(!editCtx) return;
      var wk=state.weeks.find(function(w){return w.id===editCtx.weekId});
      var obj={day:f_day.value,date:f_date.value,grade:f_grade.value,period:f_period.value,absent:f_absent.value,executed:f_exec.value,witness:f_witness.value,domain:{b:c_basics.checked,v:c_values.checked,f:c_future.checked}};
      if(editCtx.idx==null) wk.rows.push(obj); else wk.rows[editCtx.idx]=obj;
      save(); render(); closeRowModal();
    });
    cancelRowBtn.addEventListener("click",closeRowModal);
    rowModal.addEventListener("click",function(e){if(e.target===rowModal) closeRowModal();});

    addWeekBtn.addEventListener("click",function(){state.weeks.push(newWeek()); render();});

    /* ======= تصدير PDF بالعرض: الصفحة الأولى = الديباجة + أول أسبوع ======= */
    exportBtn.addEventListener("click",function(){
      var newTab = window.open("", "_blank");
      if(!newTab){ alert("رجاءً فعّل النوافذ المنبثقة مؤقتًا للتصدير."); return; }

      var area = document.getElementById("exportArea");
      var banner = document.getElementById("printBanner");
      var isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth<700;

      var sandbox = document.createElement("div");
      sandbox.id = "printSandbox";
      document.body.appendChild(sandbox);

      var cards = Array.prototype.slice.call(area.querySelectorAll(".card"));

      var firstSheet = document.createElement("div"); firstSheet.className="sheet";
      firstSheet.appendChild(banner.cloneNode(true));
      if(cards[0]) firstSheet.appendChild(cards[0].cloneNode(true));
      sandbox.appendChild(firstSheet);

      for(var i=1;i<cards.length;i++){
        var s = document.createElement("div"); s.className="sheet";
        s.appendChild(cards[i].cloneNode(true));
        sandbox.appendChild(s);
      }

      document.body.classList.add("exporting","pdf-slim");

      var pdf = new window.jspdf.jsPDF("l","mm","a4");
      var pageW=297, pageH=210;
      var scale = isMobile ? 1.1 : 1.5;

      (async function(){
        var first=true;
        for(var i=0;i<sandbox.children.length;i++){
          var page = sandbox.children[i];
          var canvas = await html2canvas(page,{scale:scale,backgroundColor:"#ffffff",useCORS:true,windowWidth:1200});
          var img = canvas.toDataURL("image/jpeg",0.92);
          var imgW=pageW, imgH=(canvas.height*imgW)/canvas.width;
          if(!first) pdf.addPage();
          pdf.addImage(img,"JPEG",0,0,imgW,imgH,undefined,"FAST");
          first=false;
          canvas.width=0; canvas.height=0;
        }
        document.body.classList.remove("exporting","pdf-slim");
        sandbox.remove();

        try{
          var blobUrl = pdf.output("bloburl");
          newTab.location.href = blobUrl;
          setTimeout(function(){ try{ URL.revokeObjectURL(blobUrl); }catch(e){} }, 60000);
        }catch(e){
          pdf.save("تقرير-حصص-الانتظار.pdf");
        }
      })();
    });

    render();
  })();
  </script>
</body>
</html>

